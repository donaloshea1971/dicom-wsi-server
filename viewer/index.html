<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>PathView Pro - Viewer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%230f172a'/%3E%3Ccircle cx='16' cy='16' r='8' fill='none' stroke='%2310b981' stroke-width='2'/%3E%3Ccircle cx='16' cy='16' r='3' fill='%2310b981'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Third-party SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/openseadragon@4.1/build/openseadragon/openseadragon.min.js"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/viewer.css?v=1.2.1">
</head>
<body>
    <!-- SVG filter for gamma correction (Hamamatsu NDPI images need gamma 2.2) -->
    <svg style="position: absolute; width: 0; height: 0;">
        <defs>
            <filter id="gamma-correction" color-interpolation-filters="sRGB">
                <feComponentTransfer>
                    <feFuncR type="gamma" amplitude="1" exponent="0.4545" offset="0"/>
                    <feFuncG type="gamma" amplitude="1" exponent="0.4545" offset="0"/>
                    <feFuncB type="gamma" amplitude="1" exponent="0.4545" offset="0"/>
                </feComponentTransfer>
            </filter>
        </defs>
    </svg>
    
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/>
                <line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/>
                <line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/>
            </svg>
            PathView Pro
        </div>
        <div class="header-controls">
            <button class="btn" onclick="refreshStudies()">‚Üª Refresh</button>
            <button class="btn btn-primary" onclick="openUploader()">+ Upload</button>
            <div class="user-menu" id="user-menu" style="display: none;">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <img id="user-avatar" src="" alt="" class="user-avatar">
                    <span id="user-name">User</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <div class="user-dropdown-header">
                        <strong id="user-email">user@example.com</strong>
                    </div>
                    <button onclick="logout()" class="logout-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üî¨ Slides</h2>
                <div class="view-toggle" style="display: flex; gap: 4px;">
                    <button id="view-flat" onclick="setViewMode('flat')" class="view-btn active" title="Flat list">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                    </button>
                    <button id="view-grouped" onclick="setViewMode('grouped')" class="view-btn" title="Group by Case/Patient">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="search-box" style="margin-top: 12px;">
                <input type="text" id="study-search" placeholder="üîç Search slides..." 
                       oninput="filterStudies(this.value)"
                       style="width: 100%; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
            </div>
        </div>
        <div class="study-list" id="study-list">
            <div class="empty-state">
                <p>Loading slides...</p>
            </div>
        </div>
    </aside>

    <!-- Main Viewer Container -->
    <main class="viewer-container">
        <div id="osd-viewer">
            <div class="viewer-placeholder" id="viewer-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                </svg>
                <h3>Select a slide to view</h3>
                <p>Choose from the sidebar or upload a new WSI file</p>
            </div>
        </div>

        <!-- Second viewer for comparison mode -->
        <div id="osd-viewer-2">
            <div class="viewer-placeholder" id="viewer-placeholder-2">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                </svg>
                <h3>Click a slide to compare</h3>
                <p>Select another slide from the sidebar</p>
            </div>
        </div>

        <!-- Compare toolbar -->
        <div class="compare-toolbar" id="compare-toolbar">
            <button id="sync-nav-btn" onclick="toggleSyncNavigation()" title="Sync pan/zoom between viewers">
                üîó Sync Nav
            </button>
            <button onclick="swapViewers()" title="Swap left and right slides">
                ‚áÑ Swap
            </button>
            <button onclick="exitCompareMode()" title="Exit comparison mode">
                ‚úï Close
            </button>
        </div>

        <!-- Status bar -->
        <div class="status-bar">
            <div class="status-badge" id="zoom-level">1.0x</div>
            <div class="status-badge" id="space-nav-badge" style="display:none; cursor:pointer;" onclick="toggleSpaceNavigator()" oncontextmenu="openSpaceMouseMenu(event)" title="Click to connect SpaceMouse">üéÆ</div>
            <div class="status-badge" id="color-badge" style="display:none; cursor:pointer;" onclick="openColorPanel()" title="Color settings">üé®</div>
            <div class="status-badge" id="help-badge" style="cursor:pointer;" onclick="toggleKeyboardHelp()" title="Keyboard shortcuts (?)">?</div>
            <div class="status-badge debug-only" id="viewer-version" style="display:none;">v1.1.0</div>
            <div class="status-badge debug-only" id="server-status" style="display:none;">Server</div>
            <div class="status-badge debug-only" id="cache-badge" style="display:none;">‚ö° Cache</div>
            <div class="status-badge debug-only" id="gamma-badge" style="display:none;">Œ≥</div>
            <div class="status-badge debug-only" id="icc-badge" style="display:none;" onclick="toggleICCInfo()">ICC</div>
        </div>

        <!-- Keyboard shortcuts help overlay -->
        <div id="keyboard-help" class="keyboard-help" style="display: none;">
            <div class="keyboard-help-content">
                <div class="keyboard-help-header">
                    <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                    <button onclick="toggleKeyboardHelp()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:20px;">&times;</button>
                </div>
                <div class="keyboard-help-grid">
                    <div class="keyboard-section">
                        <h4>Navigation</h4>
                        <div class="shortcut"><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> Pan</div>
                        <div class="shortcut"><kbd>‚Üë</kbd><kbd>‚Üê</kbd><kbd>‚Üì</kbd><kbd>‚Üí</kbd> Pan</div>
                        <div class="shortcut"><kbd>+</kbd> / <kbd>-</kbd> Zoom in/out</div>
                        <div class="shortcut"><kbd>Home</kbd> Fit to screen</div>
                        <div class="shortcut"><kbd>F</kbd> Fullscreen</div>
                        <div class="shortcut"><kbd>[</kbd> / <kbd>]</kbd> Prev/Next slide</div>
                    </div>
                    <div class="keyboard-section">
                        <h4>Zoom Levels</h4>
                        <div class="shortcut"><kbd>1</kbd> Overview (fit)</div>
                        <div class="shortcut"><kbd>2</kbd> 2x zoom</div>
                        <div class="shortcut"><kbd>3</kbd> 5x zoom</div>
                        <div class="shortcut"><kbd>4</kbd> 10x zoom</div>
                        <div class="shortcut"><kbd>5</kbd> 20x zoom</div>
                        <div class="shortcut"><kbd>6</kbd> 40x zoom</div>
                    </div>
                    <div class="keyboard-section">
                        <h4>Annotation Tools</h4>
                        <div class="shortcut"><kbd>P</kbd> Pan mode</div>
                        <div class="shortcut"><kbd>L</kbd> Line/Distance</div>
                        <div class="shortcut"><kbd>R</kbd> Rectangle/Area</div>
                        <div class="shortcut"><kbd>G</kbd> Polygon</div>
                        <div class="shortcut"><kbd>E</kbd> Ellipse/Circle</div>
                        <div class="shortcut"><kbd>M</kbd> Point marker</div>
                        <div class="shortcut"><kbd>Shift</kbd>+<kbd>A</kbd> Arrow</div>
                        <div class="shortcut"><kbd>Esc</kbd> Cancel/Pan</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Annotation Toolbar -->
        <div class="annotation-toolbar" id="annotation-toolbar" style="display: none;">
            <button class="tool-btn" id="tool-pan" title="Pan (P)" onclick="setAnnotationTool(null)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/>
                    <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
                </svg>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" id="tool-line" title="Measure Distance (L)" onclick="setAnnotationTool('line')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 12h4M18 12h4M6 12l2-2M6 12l2 2M18 12l-2-2M18 12l-2 2"/><line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
            </button>
            <button class="tool-btn" id="tool-rectangle" title="Measure Area (R)" onclick="setAnnotationTool('rectangle')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                </svg>
            </button>
            <button class="tool-btn" id="tool-polygon" title="Polygon Region (G)" onclick="setAnnotationTool('polygon')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l9 7-3.5 10h-11L3 9z"/>
                </svg>
            </button>
            <button class="tool-btn" id="tool-ellipse" title="Ellipse/Circle (E)" onclick="setAnnotationTool('ellipse')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <ellipse cx="12" cy="12" rx="9" ry="6"/>
                </svg>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" id="tool-point" title="Point Marker (M)" onclick="setAnnotationTool('point')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="8" stroke-dasharray="4 4"/>
                </svg>
            </button>
            <button class="tool-btn" id="tool-arrow" title="Arrow (Shift+A)" onclick="setAnnotationTool('arrow')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="19" x2="19" y2="5"/><polyline points="12 5 19 5 19 12"/>
                </svg>
            </button>
            <button class="tool-btn" id="tool-text" title="Text Label (T)" onclick="setAnnotationTool('text')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 7V4h16v3"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="8" y1="20" x2="16" y2="20"/>
                </svg>
            </button>
            <div class="tool-divider"></div>
            <button class="tool-btn" id="tool-list" title="Annotations List" onclick="toggleAnnotationsPanel()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
                    <circle cx="4" cy="6" r="1" fill="currentColor"/><circle cx="4" cy="12" r="1" fill="currentColor"/><circle cx="4" cy="18" r="1" fill="currentColor"/>
                </svg>
            </button>
            <button class="tool-btn" title="Clear All" onclick="clearAnnotations()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </button>
            <div class="tool-divider"></div>
            <div class="color-picker-wrapper" style="position: relative;">
                <input type="color" id="annotation-color" value="#00d4aa" 
                       onchange="setAnnotationColor(this.value)" 
                       title="Annotation Color"
                       style="width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; background: transparent;">
            </div>
        </div>

        <div class="annotations-panel" id="annotations-panel">
            <div class="annotations-panel-header">
                <h3>üìê Annotations</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn-icon" onclick="triggerImportAnnotations()" title="Import Annotations" style="padding: 4px 8px; font-size: 11px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer;">
                        üì§ Import
                    </button>
                    <input type="file" id="import-annotations-file" accept=".json,.geojson" style="display: none;" onchange="importAnnotationsFile(event)">
                    <div class="export-dropdown" style="position: relative;">
                        <button class="btn-icon" onclick="toggleExportMenu()" title="Export Annotations" style="padding: 4px 8px; font-size: 11px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer;">
                            üì• Export ‚ñæ
                        </button>
                        <div id="export-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; min-width: 140px;">
                            <button onclick="exportAnnotations('json'); toggleExportMenu();" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; color: var(--text-primary); text-align: left; cursor: pointer; font-size: 12px;">üìÑ JSON</button>
                            <button onclick="exportAnnotations('geojson'); toggleExportMenu();" style="display: block; width: 100%; padding: 8px 12px; border: none; background: none; color: var(--text-primary); text-align: left; cursor: pointer; font-size: 12px; border-top: 1px solid var(--border);">üó∫Ô∏è GeoJSON</button>
                        </div>
                    </div>
                    <button class="modal-close" onclick="toggleAnnotationsPanel()" style="font-size: 18px;">&times;</button>
                </div>
            </div>
            <div class="calibration-badge" id="calibration-info">
                <strong>Calibration:</strong> <span id="calibration-value">Loading...</span>
            </div>
            <div class="annotations-list" id="annotations-list">
                <div style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 12px;">
                    No annotations yet.<br>Use the tools on the left to add measurements.
                </div>
            </div>
        </div>

        <!-- Viewer bottom toolbar -->
        <div class="viewer-toolbar" id="viewer-toolbar" style="display: none;">
            <button class="toolbar-btn" title="Zoom In" onclick="viewer.viewport.zoomBy(1.5)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button class="toolbar-btn" title="Zoom Out" onclick="viewer.viewport.zoomBy(0.67)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button class="toolbar-btn" title="Reset View" onclick="viewer.viewport.goHome()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
            </button>
            <div class="toolbar-divider"></div>
            <button class="toolbar-btn" title="Image Info" onclick="showMetadata()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
            </button>
            <button class="toolbar-btn" title="Fullscreen" onclick="toggleFullscreen()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
        </div>
    </main>

    <!-- Modals -->
    <div id="metadata-modal" class="modal-overlay" onclick="closeMetadataModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Image Metadata</h3>
                <button class="modal-close" onclick="closeMetadataModal()">&times;</button>
            </div>
            <div id="metadata-content" class="modal-body">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <div id="color-panel" class="modal-overlay" onclick="closeColorPanel(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
            <div class="modal-header">
                <h3>üé® Color Correction</h3>
                <button class="modal-close" onclick="closeColorPanel()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">PRESET</label>
                    <select id="color-preset" onchange="applyColorPreset(this.value)" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary);">
                        <option value="sRGB">sRGB (Standard)</option>
                        <option value="Hamamatsu">Hamamatsu NDPI (Œ≥ 2.2)</option>
                        <option value="Linear">Linear (No correction)</option>
                        <option value="Vivid">Vivid (Enhanced)</option>
                        <option value="Muted">Muted (Reduced)</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">GAMMA: <span id="gamma-value">1.0</span></label>
                    <input type="range" id="gamma-slider" min="0.2" max="3.0" step="0.1" value="1.0" oninput="updateColorParam('gamma', this.value)" style="width: 100%;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">BRIGHTNESS: <span id="brightness-value">0</span></label>
                    <input type="range" id="brightness-slider" min="-0.5" max="0.5" step="0.05" value="0" oninput="updateColorParam('brightness', this.value)" style="width: 100%;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">CONTRAST: <span id="contrast-value">1.0</span></label>
                    <input type="range" id="contrast-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateColorParam('contrast', this.value)" style="width: 100%;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">SATURATION: <span id="saturation-value">1.0</span></label>
                    <input type="range" id="saturation-slider" min="0" max="2.0" step="0.1" value="1.0" oninput="updateColorParam('saturation', this.value)" style="width: 100%;">
                </div>
                
                <!-- H&E Stain Deconvolution -->
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">H&E STAIN CONTROL</span>
                        <button id="stain-toggle-btn" class="btn" onclick="toggleStainDeconv()" style="padding: 4px 10px; font-size: 11px;">OFF</button>
                    </div>
                    <div id="stain-controls" style="opacity: 0.5; pointer-events: none;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 11px;">
                                <span style="color: #6B5B95;">‚¨§</span> HEMATOXYLIN: <span id="hematoxylin-value">1.00</span>
                            </label>
                            <input type="range" id="hematoxylin-slider" min="0" max="2.0" step="0.05" value="1.0" oninput="updateStainParam('hematoxylin', this.value)" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 11px;">
                                <span style="color: #E8B4B8;">‚¨§</span> EOSIN: <span id="eosin-value">1.00</span>
                            </label>
                            <input type="range" id="eosin-slider" min="0" max="2.0" step="0.05" value="1.0" oninput="updateStainParam('eosin', this.value)" style="width: 100%;">
                        </div>
                        <div style="display: flex; gap: 4px; margin-top: 8px;">
                            <button id="view-combined" class="btn btn-primary" onclick="setStainView('combined')" style="flex: 1; padding: 4px 6px; font-size: 10px;">Combined</button>
                            <button id="view-h-only" class="btn" onclick="setStainView('hematoxylin')" style="flex: 1; padding: 4px 6px; font-size: 10px;">H Only</button>
                            <button id="view-e-only" class="btn" onclick="setStainView('eosin')" style="flex: 1; padding: 4px 6px; font-size: 10px;">E Only</button>
                        </div>
                    </div>
                </div>
                
                <div id="icc-status-panel" style="margin-top: 16px; padding: 10px; background: var(--bg-primary); border-radius: 6px; font-size: 11px; color: var(--text-secondary); display: none;">
                    <strong style="color: var(--accent);">ICC Profile:</strong> <span id="icc-status-text">Checking...</span>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button class="btn" onclick="openPerformanceEvaluation()" style="flex: 1;" title="Open display/performance evaluation (BYOD evidence)">Performance Eval</button>
                    <button class="btn" onclick="resetColorCorrection()" style="flex: 1;">Reset</button>
                    <button class="btn btn-primary" onclick="closeColorPanel()" style="flex: 1;">Done</button>
                </div>
            </div>
        </div>
    </div>

    <div id="slide-edit-dialog" class="slide-edit-dialog" style="display:none;">
        <div class="slide-edit-dialog-content">
            <div class="slide-edit-dialog-header">
                <h3>‚úèÔ∏è Edit Slide</h3>
                <button class="modal-close" onclick="closeSlideEditDialog()">&times;</button>
            </div>
            <div class="slide-edit-dialog-body">
                <input type="hidden" id="slide-edit-id">
                <label>Slide Name</label><input type="text" id="slide-edit-name">
                <label>Stain Type</label>
                <select id="slide-edit-stain">
                    <option value="">-- Select Stain --</option>
                    <option value="HE">H&E</option>
                    <option value="ER">ER</option><option value="PR">PR</option>
                    <option value="HER2">HER2</option><option value="KI67">Ki-67</option>
                    <option value="PAS">PAS</option><option value="TRICHROME">Trichrome</option>
                    <option value="OTHER">Other</option>
                </select>
                <hr style="border:none; border-top:1px solid var(--border); margin:16px 0;">
                <label>Case / Accession</label>
                <div style="display:flex; gap:8px;">
                    <select id="slide-edit-case" style="flex:1;"><option value="">-- No Case --</option></select>
                    <button class="btn btn-secondary" onclick="showNewCaseForm()" style="padding:8px 12px;">+</button>
                </div>
                <label>Block</label>
                <div style="display:flex; gap:8px;">
                    <select id="slide-edit-block" style="flex:1;"><option value="">-- No Block --</option></select>
                    <button class="btn btn-secondary" onclick="showNewBlockForm()" style="padding:8px 12px;">+</button>
                </div>
                <label>Patient</label>
                <div style="display:flex; gap:8px;">
                    <select id="slide-edit-patient" style="flex:1;"><option value="">-- No Patient --</option></select>
                    <button class="btn btn-secondary" onclick="showNewPatientForm()" style="padding:8px 12px;">+</button>
                </div>
            </div>
            <div class="slide-edit-dialog-footer" style="margin-top:20px; display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeSlideEditDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSlideEdit()">Save</button>
            </div>
        </div>
    </div>

    <div id="annotation-edit-modal" class="annotation-edit-modal">
        <div class="annotation-edit-content">
            <h3>‚úèÔ∏è Edit Annotation</h3>
            <input type="hidden" id="edit-annotation-id">
            <label>Label / Name</label>
            <input type="text" id="edit-annotation-label" placeholder="e.g., Tumor region">
            <label>Description (optional)</label>
            <textarea id="edit-annotation-desc" placeholder="Add notes..."></textarea>
            <div class="annotation-edit-buttons">
                <button class="btn" onclick="closeAnnotationEdit()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAnnotationEdit()">Save</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading" style="display:none;">
        <div class="spinner"></div>
    </div>

    <!-- Core App Logic -->
    <script src="dicomweb-tilesource.js?v=1.1.0"></script>
    <script src="color-correction.js?v=2.0.1"></script>
    <script src="annotations.js?v=1.2.0"></script>
    <script src="space-navigator.js?v=1.20.3"></script>
    
    <script src="js/auth.js?v=1.1.0"></script>
    <script src="js/study-manager.js?v=1.2.5"></script>
    <script src="js/viewer-main.js?v=1.5.0"></script>
    <script src="js/annotation-ui.js?v=1.1.0"></script>
    <script src="js/ui-controllers.js?v=1.1.5"></script>

    <script>
        // Global variables required by multiple modules
        var CONFIG = { orthancUrl: '/dicom-web', converterUrl: '/api' };

        // App Bootstrapper
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthed = await initAuth();
            if (!isAuthed && AUTH0_DOMAIN !== 'YOUR_AUTH0_DOMAIN') return;
            
            checkServerStatus();
            initSpaceNavigator();
            await refreshStudies();
            
            const params = new URLSearchParams(window.location.search);
            const studyId = params.get('study');
            if (studyId) loadStudy(studyId);
        });
    </script>
</body>
</html>
